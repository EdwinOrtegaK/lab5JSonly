<!DOCTYPE html>
<html>
<head>
</head>
<body>
    <ul id="messages"></ul>
    <textarea id="messageText" placeholder="Escribe tu mensaje aquí..."></textarea>
    <div id="charCount">0/140</div> <!-- Contador de caracteres -->
    <div id="buttonContainer"> <!-- Contenedor para los botones -->
      <button id="sendButton">ENVIAR</button>
      <button id="toggleTheme">Cambiar tema</button>
    </div>

    <script type="application/javascript">
        const ul = document.getElementById('messages');
        const t = document.getElementById('messageText');
        const b = document.getElementById('sendButton');
        const toggleThemeBtn = document.getElementById('toggleTheme');
        const buttonContainer = document.getElementById('buttonContainer')

        // Estilos aplicados con JavaScript
        document.body.style.display = 'flex';
        document.body.style.flexDirection = 'column';
        document.body.style.alignItems = 'center';
        document.body.style.marginTop = '20px';

        ul.style.listStyleType = 'none';
        ul.style.padding = '0';
        ul.style.maxHeight = '300px';
        ul.style.overflowY = 'scroll';
        ul.style.width = '100%';
        ul.style.maxWidth = '400px';
        ul.style.border = '1px solid #ccc';

        t.style.width = '100%';
        t.style.maxWidth = '400px';
        t.style.marginTop = '10px';

        buttonContainer.style.display = 'flex';
        buttonContainer.style.justifyContent = 'space-between';
        buttonContainer.style.width = '100%';
        buttonContainer.style.maxWidth = '400px';

        b.style.marginTop = '10px';
        toggleThemeBtn.style.marginTop = '10px';

        
        const getMessages = async () => {
            console.log('Fetching messages...');
            const isScrolledToBottom = ul.scrollHeight - ul.clientHeight <= ul.scrollTop + 1;
            const response = await fetch('https://chat.tiburoncin.lat/messages');
            const messages = await response.json();
            console.log('Messages received:', messages);
            const scrollPosition = ul.scrollTop;
            ul.innerHTML = ''; // Limpiar lista antes de añadir para evitar duplicados

            messages.reverse().forEach(message => {
                console.log('Processing message:', message);
                const li = document.createElement('li');
                const fragment = document.createDocumentFragment();
            
                fragment.appendChild(document.createTextNode(`${message.username}: `));
            
                let messageContent = message.message;
                let lastOffset = 0;
                const imageRegex = /(https?:\/\/\S+\.(jpg|jpeg|png|gif))/gi;
                const webPageRegex = /(https?:\/\/\S+)/gi;
            
                let matchImage, matchWebPage;
                while ((matchImage = imageRegex.exec(messageContent)) !== null) {
                    const textBeforeImage = messageContent.slice(lastOffset, matchImage.index);
                    fragment.appendChild(document.createTextNode(textBeforeImage));
                    const img = document.createElement('img');
                    img.src = matchImage[0];
                    img.style.maxWidth = '200px';
                    img.style.maxHeight = '200px';
                    img.alt = 'Imagen compartida';
                    fragment.appendChild(img);
                    lastOffset = matchImage.index + matchImage[0].length;
                }

                while ((matchWebPage = webPageRegex.exec(messageContent)) !== null) {
                    if (!matchWebPage[0].match(imageRegex)) {
                        const textBeforeLink = messageContent.slice(lastOffset, matchWebPage.index);
                        fragment.appendChild(document.createTextNode(textBeforeLink));
                        const anchor = document.createElement('a');
                        anchor.href = matchWebPage[0];
                        anchor.textContent = new URL(matchWebPage[0]).hostname;
                        anchor.target = '_blank';
                        anchor.style.wordBreak = 'break-all';
                        fragment.appendChild(anchor);
                        lastOffset = matchWebPage.index + matchWebPage[0].length;
                    }
                }
            
                const textAfterLastLink = messageContent.slice(lastOffset);
                fragment.appendChild(document.createTextNode(textAfterLastLink));
            
                li.appendChild(fragment);
                ul.appendChild(li);
            });
        
            if (isScrolledToBottom) {
                ul.scrollTop = ul.scrollHeight;
            } else {
                ul.scrollTop = scrollPosition;
            }
        };


        const postMessage = async () => {
            if (t.value.trim() === '') return; // Evita enviar mensajes vacíos

            if (t.value.length > 140) { // Verifica si el mensaje supera los 140 caracteres
                alert('El mensaje no puede superar los 140 caracteres.');
                return; // Detiene la función si el mensaje es demasiado largo
            }

            const body = {
                username: 'Kou',
                message: t.value,
            };

            await fetch('https://chat.tiburoncin.lat/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body),
            });

            t.value = ''; // Limpia el área de texto después de enviar
            await getMessages();
        };
        b.addEventListener('click', postMessage);
        toggleThemeBtn.addEventListener('click', toggleTheme);

        // Configura un intervalo para actualizar los mensajes automáticamente cada cierto tiempo
        setInterval(getMessages, 5000); // Actualiza mensajes cada 5 segundos

        t.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { // Permite el envío con Enter
                e.preventDefault(); // Evita el salto de línea predeterminado en el textarea
                postMessage(); // Llama a la función de enviar mensaje
            }
        });
        
        // Obtén mensajes al cargar la página
        getMessages();

        // Función para aplicar el tema
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.style.backgroundColor = '#333';
                document.body.style.color = '#fff';
                ul.style.borderColor = '#777';
            } else {
                document.body.style.backgroundColor = '#fff';
                document.body.style.color = '#000';
                ul.style.borderColor = '#ccc';
            }
            localStorage.setItem('theme', theme); 
        }

        // Función para cambiar el tema
        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme') === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
        }

        // Aplicar el tema guardado al cargar la página
        const savedTheme = localStorage.getItem('theme') || 'light'; // Tema por defecto: claro
        applyTheme(savedTheme);

        // Actualizar el contador de caracteres
        const charCount = document.getElementById('charCount');

        t.addEventListener('input', () => {
            const currentLength = t.value.length;
            charCount.textContent = `${currentLength}/140`; // Actualiza el texto del contador
        });

        // Llama a updateCharCount al inicio para inicializar el contador correctamente
        const updateCharCount = () => {
            const currentLength = t.value.length;
            charCount.textContent = `${currentLength}/140`;
        };

        // Inicializa el contador de caracteres cuando la página se carga
        document.addEventListener('DOMContentLoaded', () => {           
            updateCharCount();
        });
    </script>
</body>
</html>